* init.elc ビルド用の Makefile
#+begin_src makefile
EMACS	?= emacs
all: init.elc
init.el: README.org
	$(EMACS) -Q -q --batch --eval \
		"(progn \
			(require 'ob-tangle) \
			(org-babel-tangle-file \"$<\" \"$@\" \"emacs-lisp\"))"
	$(EMACS) -q -l init.el --batch --eval '(straight--transaction-finalize)' --eval '(kill-emacs)'
%.elc: %.el
	$(EMACS) -q -l init.el --batch -f batch-byte-compile $<
#+end_src

* init.el 本体
** おまじない
#+begin_src emacs-lisp
;; -*- lexical-binding: t -*-
#+end_src

** emacs -q -lした時に、user-emacs-directoryが変わるように
#+begin_src emacs-lisp
(when load-file-name
  (setq user-emacs-directory (file-name-directory load-file-name)))
#+end_src

** M-x customize したときの設定保存場所を変える
#+begin_src emacs-lisp
(setq custom-file (locate-user-emacs-file "customize.el"))
(when (file-readable-p custom-file)
  (load-file custom-file))
#+end_src

** /site-lisp を load-path に追加
#+begin_src emacs-lisp
(add-to-list 'load-path (locate-user-emacs-file "site-lisp"))
#+end_src

** basic key bindings
*** C-hをbackspaceにする
#+begin_src emacs-lisp
(define-key key-translation-map (kbd "C-h") (kbd "DEL"))
(define-key key-translation-map (kbd "M-h") (kbd "M-DEL"))
#+end_src

*** command と option をどちらも meta として扱う
#+begin_src emacs-lisp
(setq mac-command-modifier 'meta)
(setq mac-option-modifier 'meta)
#+end_src

*** 誤って終了しないようにする
#+begin_src emacs-lisp
(global-set-key (kbd "C-x C-C") 'server-edit)
(global-unset-key (kbd "C-z"))
(defalias 'exit 'save-buffers-kill-terminal)
#+end_src

*** hippie-expandを使う
#+begin_src emacs-lisp
(substitute-key-definition 'dabbrev-expand 'hippie-expand global-map)
#+end_src

** setup straight.el and leaf
*** install straight.el
#+begin_src emacs-lisp
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))
(custom-set-variables '(straight-vc-git-default-clone-depth 1))
#+end_src

*** install leaf
#+begin_src emacs-lisp
(straight-use-package 'leaf)
(straight-use-package 'leaf-keywords)
(leaf-keywords-init)
#+end_src

** 基本的なUI/UX設定
*** フォント設定
#+begin_src emacs-lisp
(defvar my-font-size 140)
(set-face-attribute 'default nil :family "Source Han Code JP" :height my-font-size)
(setq-default line-spacing 5)
#+end_src
*** posframeの不具合対処のため、nativeのfullscreenは使わない
#+begin_src emacs-lisp
(setq ns-use-native-fullscreen nil)
#+end_src

*** 各種バーを消す
#+begin_src emacs-lisp
;; (setq-default mode-line-format nil) ;; 思ったより不便だったのでモードライン非表示はやめる
;; (menu-bar-mode -1) ;; native fullscreen にするために表示させる
(when (fboundp #'tool-bar-mode)
  (tool-bar-mode -1))
(when (fboundp #'scroll-bar-mode)
  (scroll-bar-mode -1))
#+end_src

*** 折り返し表示まわり
#+begin_src emacs-lisp
(setq-default truncate-lines nil)
(setq truncate-partial-width-windows t)
#+end_src

*** 雑多な設定
**** いろいろな show の delay
#+begin_src emacs-lisp
(defvar my-show-delay 0.125)
#+end_src

**** インデントにタブを使わない
#+begin_src emacs-lisp
(setq-default indent-tabs-mode nil)
#+end_src

**** 行の先頭で C-k を一回押すだけで行全体を消去する
#+begin_src emacs-lisp
(setq kill-whole-line t)
#+end_src

**** 最終行に必ず一行挿入する
#+begin_src emacs-lisp
(setq require-final-newline t)
#+end_src

**** 補完時に大文字小文字を区別しない
#+begin_src emacs-lisp
(setq completion-ignore-case t)
(setq read-file-name-completion-ignore-case t)
#+end_src

**** ファイル先頭に #!...があるファイルを保存すると実行権をつける
#+begin_src emacs-lisp
(add-hook 'after-save-hook #'executable-make-buffer-file-executable-if-script-p)
#+end_src

**** gz ファイルも編集できるようにする
#+begin_src emacs-lisp
(auto-compression-mode t)
#+end_src

**** バックアップファイルの場所変更
#+begin_src emacs-lisp
(setq backup-directory-alist `((".*" . ,(locate-user-emacs-file "backup"))))
#+end_src

**** シンボリックリンクまわり
#+begin_src emacs-lisp
(setq vc-follow-symlinks t)
(setq auto-revert-check-vc-info t)
#+end_src

**** スクロール時にカーソルの相対位置を保つ
#+begin_src emacs-lisp
(setq scroll-preserve-screen-position :always)
#+end_src

**** カーソルの位置が何文字目かを表示する
#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook #'column-number-mode)
#+end_src

**** カーソルの位置が何行目かを表示する
#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook #'line-number-mode)
#+end_src

**** 左に行番号を表示
#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook #'global-linum-mode)
#+end_src

**** electric-pair-mode
#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook #'electric-pair-mode)
#+end_src

**** prettify
#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook #'global-prettify-symbols-mode)
#+end_src

**** 対応する括弧を表示
#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook #'show-paren-mode)
#+end_src

**** emacsclientを使う
#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook #'server-start)
#+end_src

**** 最近開いたファイル
#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook #'recentf-mode)
#+end_src

**** mac固有設定まわり
***** emacs-mac はこっち
#+begin_src emacs-lisp
(leaf input-emacs-mac
  :leaf-autoload nil
  :when (fboundp #'mac-auto-ascii-mode)
  :load-path `(,(locate-user-emacs-file "site-lisp"))
  :require fix-mac-auto-ascii-mode
  :hook (emacs-startup-hook . mac-auto-ascii-mode))
#+end_src

***** inline-patch はこっち
#+begin_src emacs-lisp
(leaf inline-patched
  :when (fboundp #'mac-input-method-mode)
  :init (mac-input-method-mode 1))
#+end_src

***** Macで使うときにGNU lsがあったらそれを使う設定
#+begin_src emacs-lisp
(leaf use-gls-when-darwin
  :when (and (eq system-type 'darwin) (executable-find "gls"))
  :custom ((insert-directory-program . "gls")))
#+end_src

** package setup
*** doom-one-theme
#+begin_src emacs-lisp
(leaf doom-themes
  :straight t
  :config
  (load-theme 'doom-one t))
#+end_src

*** exec-path-from-shell
#+begin_src emacs-lisp
(leaf exec-path-from-shell
  :straight t
  :hook (after-init-hook . exec-path-from-shell-initialize)
  :config
  (add-to-list 'exec-path-from-shell-variables "EMAIL"))
#+end_src

*** ace-window
#+begin_src emacs-lisp
(leaf ace-window
  :straight t
  :bind ("C-c o" . ace-window))
#+end_src

*** minibufferにmodelineの情報を出すやつ
#+begin_src emacs-lisp
(leaf smart-mode-line
  :straight t
  :custom (sml/no-confirm-load-theme . t)
  :hook (emacs-startup-hook . sml/setup))
(leaf rich-minority
  :straight t
  :custom ((rm-blacklist . ".*"))
  :hook (emacs-startup-hook . rich-minority-mode))
(leaf mini-modeline
  :straight t
  :hook (emacs-startup-hook . mini-modeline-mode))
#+end_src

*** languages
#+begin_src emacs-lisp
(leaf go-mode
  :straight t)
(leaf rust-mode
  :straight t)
(leaf dockerfile-mode
  :straight t)
(leaf yaml-mode
  :straight t)
(leaf fish-mode
  :straight t)
(leaf markdown-mode
  :straight t)
(leaf edit-indirect
  :straight t)
#+end_src

*** language server protocol
#+begin_src emacs-lisp
(leaf lsp-mode
  :straight t
  :hook ((go-mode-hook . lsp)
         (rust-mode-hook . lsp)
         (scala-mode-hook . lsp)))
(leaf lsp-ui
  :straight t
  :hook ((lsp-mode-hook . lsp-ui-mode)))
#+end_src

*** prescient
#+begin_src emacs-lisp
(leaf prescient
  :straight t
  :hook ((emacs-startup-hook . prescient-persist-mode)))
#+end_src

*** company
#+begin_src emacs-lisp
(leaf company
  :straight t
  :hook (emacs-startup-hook . global-company-mode)
  :custom (company-global-modes . '(not org-mode text-mode)))
(leaf company-lsp
  :straight t
  :after company-mode
  :config
  (add-to-list 'company-backends 'company-lsp))
(leaf company-prescient
  :straight t
  :hook (emacs-startup-hook . company-prescient-mode))
(leaf company-posframe
  :straight t
  :hook (emacs-startup-hook . company-posframe-mode))
#+end_src

*** ivy, counsel, swiper
#+begin_src emacs-lisp
(leaf ivy
  :straight t
  :hook ((emacs-startup-hook . ivy-mode)))
(leaf counsel
  :straight t
  :hook (emacs-startup-hook . counsel-mode))
(leaf swiper
  :straight t
  :bind ("M-s M-s" . swiper))
(leaf ivy-prescient
  :straight t
  :hook ((emacs-startup-hook . ivy-prescient-mode)))
(leaf ivy-posframe
  :straight t
  :hook ((emacs-startup-hook . ivy-posframe-mode))
  :custom ((ivy-posframe-display-functions-alist . '((swiper          . nil)
                                                     (complete-symbol . ivy-posframe-display-at-point)
                                                     (counsel-M-x     . ivy-posframe-display-at-frame-center)
                                                     (t               . nil)))))
#+end_src

*** editorconfig
#+begin_src emacs-lisp
(leaf editorconfig
  :straight t
  :hook (emacs-startup-hook . editorconfig-mode))
#+end_src

*** outshine
#+begin_src emacs-lisp
(leaf outshine
  :straight t
  :bind (("C-c q" . outshine-cycle)))
#+end_src

*** highlight-symbol
#+begin_src emacs-lisp
(leaf highlight-symbol
  :straight t
  :hook (emacs-startup-hook . highlight-symbol-mode))
#+end_src

*** M-n, M-pとかの区切りを日本語対応するやつ
#+begin_src emacs-lisp
(leaf jaword
  :straight t
  :hook (emacs-startup-hook . global-jaword-mode))
#+end_src

*** C-yとかで変更のあった場所をハイライトするやつ
#+begin_src emacs-lisp
(leaf volatile-highlights
  :straight t
  :hook (emacs-startup-hook . volatile-highlights-mode))
#+end_src

*** 途中までコマンドのキー入力したら候補を表示するやつ
#+begin_src emacs-lisp
(leaf which-key
  :straight t
  :hook (emacs-startup-hook . which-key-mode))
#+end_src

*** 括弧のネストに合わせて色をつけるやつ
#+begin_src emacs-lisp
(leaf rainbow-delimiters
  :straight t
  :hook (prog-mode-hook . rainbow-delimiters-mode-enable))
#+end_src

*** regexpをpythonのやつをつかえるようにする
#+begin_src emacs-lisp
(leaf visual-regexp
  :straight t
  :bind (("C-c r" . vr/replace)))
(leaf visual-regexp-steroids
  :straight t
  :require t
  :after visual-regexp)
#+end_src

*** undo強化
#+begin_src emacs-lisp
(leaf undo-tree
  :straight t
  :hook (emacs-startup-hook . global-undo-tree-mode))
#+end_src

*** snippet
#+begin_src emacs-lisp
(leaf yasnippet
  :straight t
  :hook (emacs-startup-hook . yas-global-mode)
  :config
  (add-to-list 'hippie-expand-try-functions-list 'yas-hippie-try-expand))
(leaf yasnippet-snippets
  :straight t
  :require t
  :after yasnippet)
(leaf ivy-yasnippet
  :straight t
  :bind (("C-c y" . ivy-yasnippet)))
#+end_src

*** magit
#+begin_src emacs-lisp
(leaf magit
  :straight t
  :bind (("C-c g" . magit-status))
  :custom ((magit-completing-read-function . 'ivy-completing-read)))
#+end_src

*** direnv
#+begin_src emacs-lisp
(leaf direnv
  :straight t
  :hook (emacs-startup-hook . direnv-mode))
#+end_src

*** eldoc
#+begin_src emacs-lisp
(leaf eldoc
  :custom ((eldoc-idle-delay . my-show-delay)
           (eldoc-echo-area-use-multiline-p . t)))
#+end_src

*** dired
#+begin_src emacs-lisp
(leaf dired
  :require dired dired-x
  :custom ((dired-listing-switches . "-alh")
           ;; diredを2つのウィンドウで開いている時に、デフォルトの移動orコピー先をもう一方のdiredで開いているディレクトリにする
           (dired-dwim-target . t)
           ;; ディレクトリを再帰的にコピーする
           (dired-recursive-copies . 'always)
           ;; diredバッファでC-sした時にファイル名だけにマッチするように
           (dired-isearch-filenames . t)))
#+end_src

*** hl-line
#+begin_src emacs-lisp
(leaf hl-line
  :defun global-hl-line-timer-function
  :require hl-line
  :init
  (defun global-hl-line-timer-function ()
    (global-hl-line-unhighlight-all)
    (let ((global-hl-line-mode t))
      (global-hl-line-highlight)))
  :setq `(global-hl-line-timer . ,(run-with-idle-timer my-show-delay t 'global-hl-line-timer-function)))
#+end_src

*** org-mode
#+begin_src emacs-lisp
(leaf org
  :straight org org-plus-contrib
  :commands (org-clock-is-active)
  :bind (("C-c c" . org-capture)
         ("C-c a" . org-agenda))
  :custom ((org-src-preserve-indentation . t)
           (org-log-done . 'time)
           (org-use-speed-commands . t)
           (org-directory . "~/org")
           (org-agenda-files . '("~/org/task.org"))
           (org-refile-targets . '((nil . (:level . 1))
                                   (org-agenda-files . (:level . 1))))
           (org-capture-templates . '(("m" "MEMO" entry (file+olp+datetree "memo.org" "Memo") "***** %U\n%?")
                                      ("d" "DIARY" entry (file+olp+datetree "diary.org" "Diary") "***** %?\n")
                                      ("t" "TRPG" entry (file+headline "trpg.org" "TRPG") "** %?\n" :jump-to-captured t)
                                      ("w" "TODO" entry (file+headline "task.org" "Task") "** TODO %?\n")))))

(leaf ox-hugo
  :straight t
  :after ox)
#+end_src

